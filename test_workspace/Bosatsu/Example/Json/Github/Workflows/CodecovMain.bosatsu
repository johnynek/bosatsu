package Bosatsu/Example/Json/Github/Workflows/CodecovMain

from Bosatsu/Json import Optional, Present

from Bosatsu/Example/Json/Github/Workflows/Util import (
  action_cache,
  action_codecov,
  action_checkout_v2,
  action_setup_java,
  action_setup_sbt,
  cat_lines,
  codecov_token_secret,
  install_sbt_step_name,
  java_distribution_temurin,
  java_matrix_setup_name,
  java_strategy_17,
  java_version_matrix,
  main_branch,
  OnPush,
  OnPushBranches,
  runner_ubuntu_latest,
  Step,
  FetchJavaWith,
  JavaStrategy,
  timeout_minutes_default,
)

struct WorkflowJobsTestWithCoverageReport(
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobs(testWithCoverageReport: WorkflowJobsTestWithCoverageReport)

struct Workflow(name: String, on: OnPush, jobs: WorkflowJobs)

workflow =
  Workflow(
    "Codecov on main",
    OnPush(OnPushBranches([ main_branch ])),
    WorkflowJobs(
      WorkflowJobsTestWithCoverageReport(
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
            with: Present(FetchJavaWith { `fetch-depth`: Present(0) }),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(
              FetchJavaWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_matrix),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("run tests with coverage"),
            run: Present(
              cat_lines([
                "sbt \"coverage; clean; coreJVM/test; cli/test; coverageReport\"",
                "",
              ]),
            ),
          },
          Step {
            uses: Present(action_codecov),
            name: Present("Upload to Codecov"),
            with: Present(
              FetchJavaWith {
                token: Present(codecov_token_secret),
                override_branch: Present(main_branch),
              },
            ),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
    ),
  )
