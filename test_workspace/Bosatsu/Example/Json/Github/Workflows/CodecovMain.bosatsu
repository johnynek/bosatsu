package Bosatsu/Example/Json/Github/Workflows/CodecovMain

from Bosatsu/Json import Set

from Bosatsu/Example/Json/Github/Workflows/Util import (
  action_codecov,
  cache_step,
  cat_lines,
  checkout_v2_fetch_depth_0_step,
  codecov_token_secret,
  java_strategy_17,
  matrix_java_fetch_step,
  main_branch,
  OnPush,
  OnPushBranches,
  runner_ubuntu_latest,
  Step,
  FetchJavaWith,
  JavaStrategy,
  setup_sbt_step,
  timeout_minutes_default,
)

struct WorkflowJobsTestWithCoverageReport(
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobs(testWithCoverageReport: WorkflowJobsTestWithCoverageReport)

struct Workflow(name: String, on: OnPush, jobs: WorkflowJobs)

coverage_setup_steps = [
  checkout_v2_fetch_depth_0_step,
  cache_step,
  matrix_java_fetch_step,
  setup_sbt_step,
]

workflow =
  Workflow(
    "Codecov on main",
    OnPush(OnPushBranches([ main_branch ])),
    WorkflowJobs(
      WorkflowJobsTestWithCoverageReport(
        runner_ubuntu_latest,
        [
          *coverage_setup_steps,
          Step {
            name: Set("run tests with coverage"),
            run: Set(cat_lines([
              "sbt \"coverage; clean; coreJVM/testOnly * -- --log=failure; cli/testOnly * -- --log=failure; coverageReport\"",
              "",
            ])),
          },
          Step {
            uses: Set(action_codecov),
            name: Set("Upload to Codecov"),
            with: Set(FetchJavaWith {
              token: Set(codecov_token_secret),
              override_branch: Set(main_branch),
            }),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
    ),
  )
