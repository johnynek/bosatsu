package Bosatsu/Example/Json/Github/Workflows/DeployWeb

from Bosatsu/Json import Optional, Absent, Present

from Bosatsu/Example/Json/Github/Workflows/Util import (
  action_cache,
  action_checkout_v2,
  action_setup_java,
  action_setup_sbt,
  cat_lines,
  github_token_secret,
  install_sbt_step_name,
  java_17_setup_name,
  java_distribution_temurin,
  java_version_17,
  main_branch,
  OnPush,
  OnPushBranches,
  permission_write,
  runner_ubuntu_latest,
  Step,
)

struct WorkflowPermissions(contents: String)

struct WorkflowJobsBuildAndDeployEnv(`BOSATSU_CI`: String, `GITHUB_TOKEN`: String)

struct WorkflowJobsBuildAndDeployStepsItemWith(
  distribution: Optional[String] = Absent,
  `java-version`: Optional[String] = Absent,
  github_token: Optional[String] = Absent,
  publish_dir: Optional[String] = Absent,
)

struct WorkflowJobsBuildAndDeploy(
  `runs-on`: String,
  env: WorkflowJobsBuildAndDeployEnv,
  steps: List[Step[WorkflowJobsBuildAndDeployStepsItemWith]],
)

struct WorkflowJobs(`build-and-deploy`: WorkflowJobsBuildAndDeploy)

struct Workflow(name: String, permissions: WorkflowPermissions, on: OnPush, jobs: WorkflowJobs)

workflow =
  Workflow(
    "Build and Deploy to GitHub Pages",
    WorkflowPermissions(permission_write),
    OnPush(OnPushBranches([ main_branch ])),
    WorkflowJobs(
      WorkflowJobsBuildAndDeploy(
        runner_ubuntu_latest,
        WorkflowJobsBuildAndDeployEnv("true", github_token_secret),
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_17_setup_name),
            with: Present(
              WorkflowJobsBuildAndDeployStepsItemWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_17),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("build app"),
            run: Present(
              cat_lines([
                "export NODE_OPTIONS=--openssl-legacy-provider",
                "sbt \"jsuiJS/fullOptJS::webpack; docs/paradox\"",
                "mkdir web_deploy",
                "mkdir web_deploy/compiler",
                "cp -a docs/target/paradox/site/main/* web_deploy",
                "cp jsui/index.html web_deploy/compiler/",
                "cp jsui/app.css web_deploy/compiler/",
                "cp jsui/.js/target/scala-3.8.1/scalajs-bundler/main/compiler-jsui-opt-bundle.js web_deploy/compiler/bosatsu_ui.js",
                "",
              ]),
            ),
          },
          Step {
            uses: Present("peaceiris/actions-gh-pages@v3"),
            name: Present("Deploy"),
            with: Present(
              WorkflowJobsBuildAndDeployStepsItemWith {
                github_token: Present(github_token_secret),
                publish_dir: Present("./web_deploy"),
              },
            ),
          },
        ],
      ),
    ),
  )
