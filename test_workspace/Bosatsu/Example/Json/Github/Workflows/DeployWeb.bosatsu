package Bosatsu/Example/Json/Github/Workflows/DeployWeb

from Bosatsu/Json import Optional, Missing, Set

from Bosatsu/Example/Json/Github/Workflows/Util import (
  cache_step,
  cat_lines,
  checkout_v2_step,
  github_token_secret,
  java_17_setup_name,
  java_distribution_temurin,
  java_version_17,
  main_branch,
  OnPush,
  OnPushBranches,
  permission_write,
  runner_ubuntu_latest,
  scala_version,
  setup_java_step,
  setup_sbt_step,
  Step,
)

struct WorkflowPermissions(contents: String)

struct WorkflowJobsBuildAndDeployEnv(`BOSATSU_CI`: String, `GITHUB_TOKEN`: String)

struct WorkflowJobsBuildAndDeployStepsItemWith(
  distribution: Optional[String] = Missing,
  `java-version`: Optional[String] = Missing,
  github_token: Optional[String] = Missing,
  publish_dir: Optional[String] = Missing,
)

struct WorkflowJobsBuildAndDeploy(
  `runs-on`: String,
  env: WorkflowJobsBuildAndDeployEnv,
  steps: List[Step[WorkflowJobsBuildAndDeployStepsItemWith]],
)

struct WorkflowJobs(`build-and-deploy`: WorkflowJobsBuildAndDeploy)

struct Workflow(name: String, permissions: WorkflowPermissions, on: OnPush, jobs: WorkflowJobs)

web_build_setup_steps = [
  checkout_v2_step,
  cache_step,
  setup_java_step(
    java_17_setup_name,
    WorkflowJobsBuildAndDeployStepsItemWith {
      distribution: Set(java_distribution_temurin),
      `java-version`: Set(java_version_17),
    },
  ),
  setup_sbt_step,
]

workflow =
  Workflow(
    "Build and Deploy to GitHub Pages",
    WorkflowPermissions(permission_write),
    OnPush(OnPushBranches([ main_branch ])),
    WorkflowJobs(
      WorkflowJobsBuildAndDeploy(
        runner_ubuntu_latest,
        WorkflowJobsBuildAndDeployEnv("true", github_token_secret),
        [
          *web_build_setup_steps,
          Step {
            name: Set("build app"),
            run: Set(cat_lines([
              "export NODE_OPTIONS=--openssl-legacy-provider",
              "sbt \"jsuiJS/fullOptJS::webpack; docs/paradox\"",
              "mkdir web_deploy",
              "mkdir web_deploy/compiler",
              "cp -a docs/target/paradox/site/main/* web_deploy",
              "cp jsui/index.html web_deploy/compiler/",
              "cp jsui/app.css web_deploy/compiler/",
              "cp jsui/.js/target/scala-${scala_version}/scalajs-bundler/main/compiler-jsui-opt-bundle.js web_deploy/compiler/bosatsu_ui.js",
              "",
            ])),
          },
          Step {
            uses: Set("peaceiris/actions-gh-pages@v3"),
            name: Set("Deploy"),
            with: Set(WorkflowJobsBuildAndDeployStepsItemWith {
              github_token: Set(github_token_secret),
              publish_dir: Set("./web_deploy"),
            }),
          },
        ],
      ),
    ),
  )
