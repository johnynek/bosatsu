package Bosatsu/Example/Json/Github/Workflows/Release

from Bosatsu/Json import Optional, Absent, Present

from Bosatsu/Example/Json/Github/Workflows/Util import (
  action_cache,
  action_checkout_v4,
  action_setup_java,
  action_setup_sbt,
  action_upload_artifact,
  cat_lines,
  FetchJavaWith,
  github_token_secret,
  install_sbt_step_name_title,
  java_17_setup_name_title,
  java_distribution_temurin,
  java_version_17,
  needs_prepare,
  Step,
  permission_write,
  runner_macos_14,
  runner_ubuntu_latest,
  StepEnv,
  run_publish_bosatsu_libs,
)

struct WorkflowOnPush(tags: List[String])

struct WorkflowOn(push: WorkflowOnPush)

struct WorkflowPermissions(contents: String, `pull-requests`: String)

struct WorkflowJobsVerifyTag(
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
)

struct WorkflowJobsPrepareOutputs(
  c_runtime_hash: String,
  c_runtime_archive: String,
  git_sha: String,
)

struct WorkflowJobsPrepare(
  `runs-on`: String,
  needs: String,
  outputs: WorkflowJobsPrepareOutputs,
  steps: List[Step[FetchJavaWith]],
)

struct WorkflowJobsBuildCli(
  `runs-on`: String,
  needs: String,
  steps: List[Step[FetchJavaWith]],
)

struct WorkflowJobsNativeLinux(
  `runs-on`: String,
  needs: String,
  steps: List[Step[FetchJavaWith]],
)

struct WorkflowJobsNativeMacosStepsItemWith(
  `fetch-depth`: Optional[Int] = Absent,
  distribution: Optional[String] = Absent,
  `java-version`: Optional[String] = Absent,
  architecture: Optional[String] = Absent,
  name: Optional[String] = Absent,
  path: Optional[String] = Absent,
)

struct WorkflowJobsNativeMacos(
  `runs-on`: String,
  needs: String,
  steps: List[Step[WorkflowJobsNativeMacosStepsItemWith]],
)

struct WorkflowJobsReleaseStepsItemWith(
  `fetch-depth`: Optional[Int] = Absent,
  path: Optional[String] = Absent,
  `merge-multiple`: Optional[Bool] = Absent,
  distribution: Optional[String] = Absent,
  `java-version`: Optional[String] = Absent,
  name: Optional[String] = Absent,
  tag_name: Optional[String] = Absent,
  generate_release_notes: Optional[Bool] = Absent,
  files: Optional[String] = Absent,
)

struct WorkflowJobsRelease(
  `runs-on`: String,
  needs: List[String],
  steps: List[Step[WorkflowJobsReleaseStepsItemWith]],
)

struct WorkflowJobs(
  verify_tag: WorkflowJobsVerifyTag,
  prepare: WorkflowJobsPrepare,
  build_cli: WorkflowJobsBuildCli,
  native_linux: WorkflowJobsNativeLinux,
  native_macos: WorkflowJobsNativeMacos,
  release: WorkflowJobsRelease,
)

struct Workflow(name: String, on: WorkflowOn, permissions: WorkflowPermissions, jobs: WorkflowJobs)

def tag_env(tag_name: String) -> StepEnv:
  StepEnv { `TAG_NAME`: Present(tag_name) }

def runtime_hash_env(hash: String) -> StepEnv:
  StepEnv { `BOSATSU_C_RUNTIME_HASH`: Present(hash) }

def native_linux_env(
  hash: String,
  static_native: String,
  libc: String,
  clib_path: String,
  cc: String,
) -> StepEnv:
  StepEnv {
    `BOSATSU_C_RUNTIME_HASH`: Present(hash),
    `BOSATSU_STATIC_NATIVE_IMAGE`: Present(static_native),
    `BOSATSU_NATIVE_IMAGE_LIBC`: Present(libc),
    `BOSATSU_NATIVE_IMAGE_CLIB_PATH`: Present(clib_path),
    `CC`: Present(cc),
  }

def release_env(
  `BOSATSU_C_RUNTIME_HASH`: Optional[String],
  `PGP_PASSPHRASE`: Optional[String],
  `PGP_SECRET`: Optional[String],
  `SONATYPE_PASSWORD`: Optional[String],
  `SONATYPE_USERNAME`: Optional[String],
  `REPO_ROOT`: Optional[String],
  `OUTDIR`: Optional[String],
  `GIT_SHA`: Optional[String],
  `URI_BASE`: Optional[String],
  `C_RUNTIME_ARCHIVE`: Optional[String],
  `GITHUB_TOKEN`: Optional[String],
  `GITHUB_REF_NAME`: Optional[String],
  `GH_TOKEN`: Optional[String],
) -> StepEnv:
  StepEnv {
    `BOSATSU_C_RUNTIME_HASH`,
    `PGP_PASSPHRASE`,
    `PGP_SECRET`,
    `SONATYPE_PASSWORD`,
    `SONATYPE_USERNAME`,
    `REPO_ROOT`,
    `OUTDIR`,
    `GIT_SHA`,
    `URI_BASE`,
    `C_RUNTIME_ARCHIVE`,
    `GITHUB_TOKEN`,
    `GITHUB_REF_NAME`,
    `GH_TOKEN`,
  }

workflow =
  Workflow(
    "Release",
    WorkflowOn(WorkflowOnPush([ "v*" ])),
    WorkflowPermissions(permission_write, permission_write),
    WorkflowJobs(
      WorkflowJobsVerifyTag(
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v4),
            name: Present("Check out code"),
            with: Present(FetchJavaWith { `fetch-depth`: Present(0) }),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_17_setup_name_title),
            with: Present(
              FetchJavaWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_17),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name_title),
          },
          Step {
            name: Present("Install b3sum"),
            run: Present("sudo apt-get update && sudo apt-get install -y b3sum"),
          },
          Step {
            name: Present("Verify tag matches sbt version"),
            run: Present(cat_lines([
              "set -euo pipefail",
              "python3 scripts/verify_release_tag.py",
              "",
            ])),
            env: Present(tag_env("\${{ github.ref_name }}")),
          },
        ],
      ),
      WorkflowJobsPrepare(
        runner_ubuntu_latest,
        "verify_tag",
        WorkflowJobsPrepareOutputs(
          "\${{ steps.cruntime.outputs.c_runtime_hash }}",
          "\${{ steps.cruntime.outputs.c_runtime_archive }}",
          "\${{ steps.cruntime.outputs.git_sha }}",
        ),
        [
          Step {
            uses: Present(action_checkout_v4),
            name: Present("Check out code"),
            with: Present(FetchJavaWith { `fetch-depth`: Present(0) }),
          },
          Step {
            name: Present("Install b3sum"),
            run: Present("sudo apt-get update && sudo apt-get install -y b3sum"),
          },
          Step {
            name: Present("Create c_runtime archive"),
            run: Present(
              cat_lines([
                "set -euo pipefail",
                "sha=\"$(git rev-parse HEAD)\"",
                "archive=\"bosatsu-c-runtime-\${sha}.tar.gz\"",
                "tar -czf \"\${archive}\" c_runtime",
                "hash=\"$(b3sum \"\${archive}\" | awk '{print $1}')\"",
                "echo \"git_sha=\${sha}\" >> \"$GITHUB_OUTPUT\"",
                "echo \"c_runtime_archive=\${archive}\" >> \"$GITHUB_OUTPUT\"",
                "echo \"c_runtime_hash=blake3:\${hash}\" >> \"$GITHUB_OUTPUT\"",
                "",
              ]),
            ),
            id: Present("cruntime"),
          },
          Step {
            uses: Present(action_upload_artifact),
            name: Present("Upload c_runtime archive"),
            with: Present(
              FetchJavaWith {
                name: Present("bosatsu-c-runtime"),
                path: Present("\${{ steps.cruntime.outputs.c_runtime_archive }}"),
              },
            ),
          },
        ],
      ),
      WorkflowJobsBuildCli(
        runner_ubuntu_latest,
        needs_prepare,
        [
          Step {
            uses: Present(action_checkout_v4),
            name: Present("Check out code"),
            with: Present(FetchJavaWith { `fetch-depth`: Present(0) }),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_17_setup_name_title),
            with: Present(
              FetchJavaWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_17),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name_title),
          },
          Step {
            name: Present("Build jar and node JS"),
            run: Present(
              cat_lines([
                "sbt \"++3.8.1; cli/assembly; cliJSJS/fullOptJS\"",
                "cp cli/target/scala-3.8.1/bosatsu-cli-assembly-*.jar bosatsu.jar",
                "target_dir=\"\"",
                "for d in cliJS/.js/target/scala-*; do",
                "  if [ -d \"$d\" ]; then",
                "    target_dir=\"$d\"",
                "    break",
                "  fi",
                "done",
                "if [ -z \"$target_dir\" ]; then",
                "  echo \"Missing cliJS Scala.js target (run sbt \\\"cliJSJS/fullOptJS\\\")\" >&2",
                "  exit 1",
                "fi",
                "for candidate in \\",
                "  \"$target_dir/compiler-clijs-opt.js\" \\",
                "  \"$target_dir/compiler-clijs-opt/main.js\"",
                "do",
                "  if [ -f \"$candidate\" ]; then",
                "    cp \"$candidate\" bosatsu_node.js",
                "    exit 0",
                "  fi",
                "done",
                "echo \"Compiled cliJS output not found in \${target_dir}\" >&2",
                "exit 1",
                "",
              ]),
            ),
            env: Present(runtime_hash_env("\${{ needs.prepare.outputs.c_runtime_hash }}")),
          },
          Step {
            uses: Present(action_upload_artifact),
            name: Present("Upload jar"),
            with: Present(
              FetchJavaWith {
                name: Present("bosatsu-jar"),
                path: Present("bosatsu.jar"),
              },
            ),
          },
          Step {
            uses: Present(action_upload_artifact),
            name: Present("Upload node JS"),
            with: Present(
              FetchJavaWith {
                name: Present("bosatsu-node"),
                path: Present("bosatsu_node.js"),
              },
            ),
          },
        ],
      ),
      WorkflowJobsNativeLinux(
        runner_ubuntu_latest,
        needs_prepare,
        [
          Step {
            uses: Present(action_checkout_v4),
            name: Present("Check out code"),
            with: Present(FetchJavaWith { `fetch-depth`: Present(0) }),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_17_setup_name_title),
            with: Present(
              FetchJavaWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_17),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name_title),
          },
          Step {
            name: Present("Install musl toolchain"),
            run: Present("sudo apt-get update && sudo apt-get install -y musl-tools build-essential"),
          },
          Step {
            name: Present("Build musl zlib"),
            run: Present(
              cat_lines([
                "set -euo pipefail",
                "zlib_version=\"1.3.1\"",
                "zlib_sha256=\"9a93b2b7dfdac77ceba5a558a580e74667dd6fede4585b91eefb60f03b72df23\"",
                "zlib_url=\"https://github.com/madler/zlib/releases/download/v\${zlib_version}/zlib-\${zlib_version}.tar.gz\"",
                "curl -fsSL \"$zlib_url\" -o /tmp/zlib.tar.gz",
                "echo \"\${zlib_sha256}  /tmp/zlib.tar.gz\" | sha256sum -c -",
                "rm -rf /tmp/zlib-src",
                "mkdir -p /tmp/zlib-src",
                "tar -xzf /tmp/zlib.tar.gz -C /tmp/zlib-src --strip-components=1",
                "cd /tmp/zlib-src",
                "CC=musl-gcc ./configure --static --prefix=/usr/local/musl",
                "make -j\"$(nproc)\"",
                "sudo make install",
                "",
              ]),
            ),
          },
          Step {
            name: Present("Build native image (linux static)"),
            run: Present(
              cat_lines([
                "sbt \"++3.8.1; cli/nativeImage\"",
                "cp cli/target/native-image/bosatsu-cli bosatsu-linux",
                "",
              ]),
            ),
            env: Present(
              native_linux_env(
                "\${{ needs.prepare.outputs.c_runtime_hash }}",
                "true",
                "musl",
                "/usr/local/musl/lib",
                "musl-gcc",
              ),
            ),
          },
          Step {
            uses: Present(action_upload_artifact),
            name: Present("Upload linux native image"),
            with: Present(
              FetchJavaWith {
                name: Present("bosatsu-native-linux"),
                path: Present("bosatsu-linux"),
              },
            ),
          },
        ],
      ),
      WorkflowJobsNativeMacos(
        runner_macos_14,
        needs_prepare,
        [
          Step {
            uses: Present(action_checkout_v4),
            name: Present("Check out code"),
            with: Present(WorkflowJobsNativeMacosStepsItemWith { `fetch-depth`: Present(0) }),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_17_setup_name_title),
            with: Present(
              WorkflowJobsNativeMacosStepsItemWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_17),
                architecture: Present("aarch64"),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name_title),
          },
          Step {
            name: Present("Build native image (macos)"),
            run: Present(
              cat_lines([
                "sbt \"++3.8.1; cli/nativeImage\"",
                "cp cli/target/native-image/bosatsu-cli bosatsu-macos",
                "uname -m",
                "file bosatsu-macos",
                "file bosatsu-macos | grep -q \"arm64\" || { echo \"Expected arm64 binary\"; exit 1; }",
                "",
              ]),
            ),
            env: Present(
              runtime_hash_env("\${{ needs.prepare.outputs.c_runtime_hash }}"),
            ),
          },
          Step {
            uses: Present(action_upload_artifact),
            name: Present("Upload macos native image"),
            with: Present(
              WorkflowJobsNativeMacosStepsItemWith {
                name: Present("bosatsu-native-macos"),
                path: Present("bosatsu-macos"),
              },
            ),
          },
        ],
      ),
      WorkflowJobsRelease(
        runner_ubuntu_latest,
        [ needs_prepare, "build_cli", "native_linux", "native_macos" ],
        [
          Step {
            uses: Present(action_checkout_v4),
            name: Present("Check out code"),
            with: Present(
              WorkflowJobsReleaseStepsItemWith { `fetch-depth`: Present(0) },
            ),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present("actions/download-artifact@v4"),
            name: Present("Download artifacts"),
            with: Present(
              WorkflowJobsReleaseStepsItemWith {
                path: Present("release_assets"),
                `merge-multiple`: Present(True),
              },
            ),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_17_setup_name_title),
            with: Present(
              WorkflowJobsReleaseStepsItemWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_17),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name_title),
          },
          Step {
            name: Present("Install b3sum"),
            run: Present("sudo apt-get update && sudo apt-get install -y b3sum"),
          },
          Step {
            name: Present("Publish JVM/JS artifacts to Sonatype"),
            run: Present("sbt ci-release"),
            env: Present(
              release_env(
                Present("\${{ needs.prepare.outputs.c_runtime_hash }}"),
                Present("\${{ secrets.PGP_PASSPHRASE }}"),
                Present("\${{ secrets.PGP_SECRET }}"),
                Present("\${{ secrets.SONATYPE_PASSWORD }}"),
                Present("\${{ secrets.SONATYPE_USERNAME }}"),
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            name: Present("Build assembly for lib publish"),
            run: Present("sbt \"++3.8.1; cli/assembly\""),
            env: Present(
              release_env(
                Present("\${{ needs.prepare.outputs.c_runtime_hash }}"),
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            name: Present("Publish Bosatsu libraries"),
            run: Present(run_publish_bosatsu_libs),
            env: Present(
              release_env(
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Present("\${{ github.workspace }}"),
                Present("\${{ github.workspace }}/.bosatsu_lib_publish"),
                Present("\${{ needs.prepare.outputs.git_sha }}"),
                Present(
                  "https://github.com/\${{ github.repository }}/releases/download/\${{ github.ref_name }}/",
                ),
                Absent,
                Absent,
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            name: Present("Stage release assets"),
            run: Present(
              cat_lines([
                "set -euo pipefail",
                "mkdir -p release_assets",
                "cp bosatsu release_assets/",
                "cp proto/src/main/protobuf/bosatsu/TypedAst.proto release_assets/",
                "cp .bosatsu_lib_publish/*.bosatsu_lib release_assets/",
                "chmod +x release_assets/bosatsu || true",
                "required_files=(",
                "  \"bosatsu.jar\"",
                "  \"bosatsu_node.js\"",
                "  \"bosatsu-linux\"",
                "  \"bosatsu-macos\"",
                "  \"bosatsu\"",
                "  \"TypedAst.proto\"",
                "  \"\${C_RUNTIME_ARCHIVE}\"",
                ")",
                "for file in \"\${required_files[@]}\"; do",
                "  if [ ! -f \"release_assets/\${file}\" ]; then",
                "    echo \"Missing release asset: \${file}\" >&2",
                "    exit 1",
                "  fi",
                "done",
                "",
              ]),
            ),
            env: Present(
              release_env(
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Present("\${{ needs.prepare.outputs.c_runtime_archive }}"),
                Absent,
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            name: Present("Create SHA256SUMS"),
            run: Present(
              cat_lines([
                "set -euo pipefail",
                "cd release_assets",
                "find . -maxdepth 1 -type f ! -name 'SHA256SUMS' ! -name 'B3SUMS' -print0 \\",
                "  | sort -z \\",
                "  | xargs -0 sha256sum > SHA256SUMS",
                "",
              ]),
            ),
            env: Present(
              release_env(
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Present("\${{ needs.prepare.outputs.c_runtime_archive }}"),
                Absent,
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            name: Present("Create B3SUMS"),
            run: Present(
              cat_lines([
                "set -euo pipefail",
                "cd release_assets",
                "find . -maxdepth 1 -type f ! -name 'B3SUMS' -print0 \\",
                "  | sort -z \\",
                "  | xargs -0 b3sum > B3SUMS",
                "",
              ]),
            ),
            env: Present(
              release_env(
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Present("\${{ needs.prepare.outputs.c_runtime_archive }}"),
                Absent,
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            uses: Present("softprops/action-gh-release@v2"),
            name: Present("Create GitHub release"),
            with: Present(
              WorkflowJobsReleaseStepsItemWith {
                name: Present("Release \${{ github.ref_name }}"),
                tag_name: Present("\${{ github.ref_name }}"),
                generate_release_notes: Present(True),
                files: Present(cat_lines([
                  "release_assets/*",
                  "",
                ])),
              },
            ),
            env: Present(
              release_env(
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Present(github_token_secret),
                Absent,
                Absent,
              ),
            ),
          },
          Step {
            name: Present("Create PR for core_conf.json changes"),
            run: Present(
              cat_lines([
                "set -euo pipefail",
                "echo \"Changes after bosatsu lib publish:\"",
                "git status",
                "git diff",
                "",
                "git config user.name \"bosatsu-release-bot\"",
                "git config user.email \"bosatsu-release-bot@users.noreply.github.com\"",
                "",
                "git add **/*_conf.json",
                "",
                "if git diff --cached --quiet; then",
                "  echo \"No core_conf.json changes to commit, skipping push.\"",
                "  exit 0",
                "fi",
                "",
                "branch=\"release/conf-\${GITHUB_REF_NAME}\"",
                "git checkout -B \"$branch\"",
                "git commit -m \"Update lib conf.jsons for \${GITHUB_REF_NAME}\"",
                "git push -u --force-with-lease origin \"$branch\"",
                "",
                "if gh pr view \"$branch\" >/dev/null 2>&1; then",
                "  echo \"PR already exists for \${branch}, skipping create.\"",
                "  exit 0",
                "fi",
                "",
                "gh pr create \\",
                "  --base main \\",
                "  --head \"$branch\" \\",
                "  --title \"Update lib conf.jsons for \${GITHUB_REF_NAME}\" \\",
                "  --body \"Automated updates for \${GITHUB_REF_NAME} release.\"",
                "",
              ]),
            ),
            env: Present(
              release_env(
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Absent,
                Present("\${{ github.ref_name }}"),
                Present(github_token_secret),
              ),
            ),
          },
        ],
      ),
    ),
  )
