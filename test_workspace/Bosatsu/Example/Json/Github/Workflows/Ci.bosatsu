package Bosatsu/Example/Json/Github/Workflows/Ci

from Bosatsu/Json import Optional, Absent, Present

from Bosatsu/Example/Json/Github/Workflows/Util import (
  action_cache,
  action_codecov,
  action_checkout_v2,
  action_setup_java,
  action_setup_python,
  action_setup_sbt,
  cat_lines,
  codecov_token_secret,
  Step,
  JavaWith,
  FetchJavaWith,
  JavaStrategy,
  StepEnv,
  install_sbt_step_name,
  java_distribution_temurin,
  java_matrix_setup_name,
  java_strategy_17,
  java_version_17,
  java_version_matrix,
  needs_test,
  needs_test_c,
  python_version_matrix,
  python_version_3_9,
  runner_macos_latest,
  runner_ubuntu_latest,
  run_python_tests_cmd,
  run_publish_bosatsu_libs,
  run_c_runtime_ci,
  run_lib_test_c,
  run_lib_build_c,
  tool_test_workspace_cmd,
  tool_test_workspace_node_cmd,
  transpile_c_cmd,
  transpile_python_cmd,
  timeout_minutes_default,
)

struct WorkflowJobsTest(
  `runs-on`: String,
  steps: List[Step[JavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsTestPYStepsItemWith(
  distribution: Optional[String] = Absent,
  `java-version`: Optional[String] = Absent,
  `python-version`: Optional[String] = Absent,
)

struct WorkflowJobsTestPYStrategyMatrix(java: List[String], python: List[String])

struct WorkflowJobsTestPYStrategy(matrix: WorkflowJobsTestPYStrategyMatrix)

struct WorkflowJobsTestPY(
  needs: String,
  `runs-on`: String,
  steps: List[Step[WorkflowJobsTestPYStepsItemWith]],
  strategy: WorkflowJobsTestPYStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsTestJS(
  needs: String,
  `runs-on`: String,
  steps: List[Step[JavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsTestWithCoverageReport(
  needs: String,
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsNeedsRunStepsStrategy(
  needs: String,
  `runs-on`: String,
  steps: List[Step[JavaWith]],
  strategy: JavaStrategy,
)

struct WorkflowJobsNeedsRunStrategyStepsTimeout(
  needs: String,
  `runs-on`: String,
  strategy: JavaStrategy,
  steps: List[Step[JavaWith]],
  `timeout-minutes`: Int,
)

struct WorkflowJobsLibPublishDryRun(
  needs: String,
  `runs-on`: String,
  steps: List[Step[JavaWith]],
  strategy: JavaStrategy,
)

struct WorkflowJobs(
  test: WorkflowJobsTest,
  testPY: WorkflowJobsTestPY,
  testJS: WorkflowJobsTestJS,
  testWithCoverageReport: WorkflowJobsTestWithCoverageReport,
  buildWithGraal: WorkflowJobsNeedsRunStepsStrategy,
  testWithNode: WorkflowJobsNeedsRunStepsStrategy,
  testC: WorkflowJobsNeedsRunStrategyStepsTimeout,
  testCMacOS: WorkflowJobsNeedsRunStrategyStepsTimeout,
  libPublishDryRun: WorkflowJobsLibPublishDryRun,
)

struct WorkflowOnPullRequest

struct WorkflowOn(pull_request: WorkflowOnPullRequest)

struct Workflow(jobs: WorkflowJobs, name: String, on: WorkflowOn)

workflow =
  Workflow(
    WorkflowJobs(
      WorkflowJobsTest(
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("run JVM tests"),
            run: Present(cat_lines([
              "sbt \"coreJVM/test; cli/test; doc; paradox\"",
              "./test_cli.sh",
              "",
            ])),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
      WorkflowJobsTestPY(
        needs_test,
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(
              WorkflowJobsTestPYStepsItemWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_matrix),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            uses: Present(action_setup_python),
            name: Present("python setup"),
            with: Present(
              WorkflowJobsTestPYStepsItemWith {
                `python-version`: Present(python_version_matrix),
              },
            ),
          },
          Step {
            name: Present("build assembly"),
            run: Present("sbt \"cli/assembly\""),
          },
          Step {
            name: Present("generate python code"),
            run: Present(transpile_python_cmd),
          },
          Step {
            name: Present("run python tests"),
            run: Present(run_python_tests_cmd),
          },
        ],
        WorkflowJobsTestPYStrategy(
          WorkflowJobsTestPYStrategyMatrix(
            [ java_version_17 ],
            [ python_version_3_9 ],
          ),
        ),
        timeout_minutes_default,
      ),
      WorkflowJobsTestJS(
        needs_test,
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("run coreJS tests"),
            run: Present(cat_lines([
              "sbt \"coreJS/test; jsapiJS/compile\"",
              "sbt \"jsuiJS/test\"",
              "",
            ])),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
      WorkflowJobsTestWithCoverageReport(
        needs_test,
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
            with: Present(FetchJavaWith { `fetch-depth`: Present(0) }),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(
              FetchJavaWith {
                distribution: Present(java_distribution_temurin),
                `java-version`: Present(java_version_matrix),
              },
            ),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("run tests with coverage"),
            run: Present(cat_lines([
              "sbt \"coverage; clean; coreJVM/test; cli/test; coverageReport\"",
              "",
            ])),
          },
          Step {
            uses: Present(action_codecov),
            name: Present("Upload to Codecov"),
            with: Present(
              FetchJavaWith { token: Present(codecov_token_secret) },
            ),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
      WorkflowJobsNeedsRunStepsStrategy(
        needs_test,
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("build native image"),
            run: Present(cat_lines([
              "sbt \"cli/nativeImage\"",
              "cp cli/target/native-image/bosatsu-cli bosatsu",
              "",
            ])),
          },
          Step {
            name: Present("run bosatsu tests"),
            run: Present(
              cat_lines([
                tool_test_workspace_cmd,
                "",
              ]),
            ),
          },
        ],
        java_strategy_17,
      ),
      WorkflowJobsNeedsRunStepsStrategy(
        needs_test,
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("build node"),
            run: Present(cat_lines([
              "sbt \"cliJSJS/fullOptJS\"",
              "",
            ])),
          },
          Step {
            name: Present("run bosatsu tests"),
            run: Present(
              cat_lines([
                tool_test_workspace_node_cmd,
                "",
              ]),
            ),
          },
          Step {
            name: Present("install boehm"),
            run: Present("sudo apt-get update && sudo apt-get install -y libgc1 libgc-dev"),
          },
          Step {
            name: Present("install c runtime"),
            run: Present(cat_lines([
              "make -C c_runtime install VERSION=$(git rev-parse HEAD)",
              "",
            ])),
          },
          Step {
            name: Present("run lib test"),
            run: Present(
              cat_lines([
                "./bosatsu_node lib fetch",
                "mkdir node_out_lib",
                "./bosatsu_node lib test --outdir node_out_lib",
                "echo \"now test without a given outdir\"",
                "./bosatsu_node lib test",
                "",
              ]),
            ),
          },
        ],
        java_strategy_17,
      ),
      WorkflowJobsNeedsRunStrategyStepsTimeout(
        needs_test,
        runner_ubuntu_latest,
        java_strategy_17,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("build assembly"),
            run: Present("sbt \"cli/assembly\""),
          },
          Step {
            name: Present("install boehm"),
            run: Present("sudo apt-get update && sudo apt install -y libgc1 libgc-dev pkg-config"),
          },
          Step {
            name: Present("test runtime code"),
            run: Present(run_c_runtime_ci),
          },
          Step {
            name: Present("generate and compile c code"),
            run: Present(transpile_c_cmd),
          },
          Step {
            name: Present("run generated c code"),
            run: Present("./c_out/test_exe"),
          },
          Step {
            name: Present("check single assertion test output"),
            run: Present(
              cat_lines([
                "rm -rf issue1642_repro",
                "mkdir issue1642_repro",
                "cat > issue1642_repro/Foo.bosatsu <<'EOF'",
                "package Foo",
                "test = Assertion(True, \"foo\")",
                "EOF",
                "./bosatsuj tool transpile --input issue1642_repro/Foo.bosatsu --package_root issue1642_repro c --outdir issue1642_repro/out --test --exe_out test_exe --cc_flag=-O0 --cc_lib=-lm",
                "issue1642_repro/out/test_exe | tee issue1642_repro/output.txt",
                "grep -Eq '^Foo:$' issue1642_repro/output.txt",
                "grep -Eq '^    passed: .*1' issue1642_repro/output.txt",
                "",
              ]),
            ),
          },
          Step {
            name: Present("run lib test"),
            run: Present(run_lib_test_c),
          },
          Step {
            name: Present("run lib build"),
            run: Present(run_lib_build_c),
          },
        ],
        timeout_minutes_default,
      ),
      WorkflowJobsNeedsRunStrategyStepsTimeout(
        needs_test,
        runner_macos_latest,
        java_strategy_17,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("build assembly"),
            run: Present("sbt \"cli/assembly\""),
          },
          Step {
            name: Present("install boehm"),
            run: Present("brew install bdw-gc pkg-config"),
          },
          Step {
            name: Present("test runtime code"),
            run: Present(run_c_runtime_ci),
          },
          Step {
            name: Present("generate and compile c code"),
            run: Present(transpile_c_cmd),
          },
          Step {
            name: Present("run generated c code"),
            run: Present("./c_out/test_exe"),
          },
          Step {
            name: Present("run lib test"),
            run: Present(run_lib_test_c),
          },
          Step {
            name: Present("run lib build"),
            run: Present(run_lib_build_c),
          },
        ],
        timeout_minutes_default,
      ),
      WorkflowJobsLibPublishDryRun(
        needs_test_c,
        runner_ubuntu_latest,
        [
          Step {
            uses: Present(action_checkout_v2),
          },
          Step {
            uses: Present(action_cache),
          },
          Step {
            uses: Present(action_setup_java),
            name: Present(java_matrix_setup_name),
            with: Present(JavaWith(java_distribution_temurin, java_version_matrix)),
          },
          Step {
            uses: Present(action_setup_sbt),
            name: Present(install_sbt_step_name),
          },
          Step {
            name: Present("build assembly"),
            run: Present("sbt \"++3.8.1; cli/assembly\""),
          },
          Step {
            name: Present("dry run bosatsu lib publish"),
            run: Present(run_publish_bosatsu_libs),
            env: Present(
              StepEnv {
                `REPO_ROOT`: Present("\${{ github.workspace }}"),
                `OUTDIR`: Present("\${{ runner.temp }}/bosatsu_lib_publish"),
                `GIT_SHA`: Present("\${{ github.sha }}"),
                `URI_BASE`: Present("https://example.invalid/"),
              },
            ),
          },
        ],
        java_strategy_17,
      ),
    ),
    "ci",
    WorkflowOn(WorkflowOnPullRequest),
  )
