package Bosatsu/Example/Json/Github/Workflows/Ci

from Bosatsu/Json import Set

from Bosatsu/Example/Json/Github/Workflows/Util import (
  action_codecov,
  action_setup_python,
  cat_lines,
  checkout_v2_fetch_depth_0_step,
  checkout_v2_step,
  codecov_token_secret,
  Step,
  FetchJavaWith,
  JavaStrategy,
  matrix_java_fetch_step,
  StepEnv,
  java_strategy_17,
  java_version_17,
  needs_test,
  needs_test_c,
  node_lib_eval_run_create_mode_cmd,
  node_tool_eval_run_create_mode_cmd,
  python_version_matrix,
  python_version_3_9,
  runner_macos_latest,
  runner_ubuntu_latest,
  run_python_tests_cmd,
  run_publish_bosatsu_libs,
  run_c_runtime_ci,
  run_lib_test_c,
  run_lib_build_c,
  setup_sbt_step,
  tool_test_workspace_cmd,
  tool_test_workspace_node_cmd,
  transpile_c_cmd,
  transpile_python_cmd,
  sbt_cache_fetch_step,
  timeout_minutes_default,
)

struct WorkflowJobsTest(
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsTestPYStrategyMatrix(java: List[String], python: List[String])

struct WorkflowJobsTestPYStrategy(matrix: WorkflowJobsTestPYStrategyMatrix)

struct WorkflowJobsTestPY(
  needs: String,
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: WorkflowJobsTestPYStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsTestJS(
  needs: String,
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsTestWithCoverageReport(
  needs: String,
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
  `timeout-minutes`: Int,
)

struct WorkflowJobsNeedsRunStepsStrategy(
  needs: String,
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
)

struct WorkflowJobsNeedsRunStrategyStepsTimeout(
  needs: String,
  `runs-on`: String,
  strategy: JavaStrategy,
  steps: List[Step[FetchJavaWith]],
  `timeout-minutes`: Int,
)

struct WorkflowJobsLibPublishDryRun(
  needs: String,
  `runs-on`: String,
  steps: List[Step[FetchJavaWith]],
  strategy: JavaStrategy,
)

struct WorkflowJobs(
  test: WorkflowJobsTest,
  testPY: WorkflowJobsTestPY,
  testJS: WorkflowJobsTestJS,
  testWithCoverageReport: WorkflowJobsTestWithCoverageReport,
  buildWithGraal: WorkflowJobsNeedsRunStepsStrategy,
  testWithNode: WorkflowJobsNeedsRunStepsStrategy,
  testC: WorkflowJobsNeedsRunStrategyStepsTimeout,
  testCMacOS: WorkflowJobsNeedsRunStrategyStepsTimeout,
  libPublishDryRun: WorkflowJobsLibPublishDryRun,
)

struct WorkflowOnPullRequest

struct WorkflowOn(pull_request: WorkflowOnPullRequest)

struct Workflow(jobs: WorkflowJobs, name: String, on: WorkflowOn)

java_matrix_bootstrap_steps = [
  checkout_v2_step,
  sbt_cache_fetch_step,
  matrix_java_fetch_step,
  setup_sbt_step,
]

coverage_bootstrap_steps = [
  checkout_v2_fetch_depth_0_step,
  sbt_cache_fetch_step,
  matrix_java_fetch_step,
  setup_sbt_step,
]

py_bootstrap_steps = [
  checkout_v2_step,
  sbt_cache_fetch_step,
  matrix_java_fetch_step,
  setup_sbt_step,
]

c_build_bootstrap_steps = [
  checkout_v2_step,
  matrix_java_fetch_step,
  setup_sbt_step,
]

run_bosatsu_tests_step =
  Step {
    name: Set("run bosatsu tests"),
    run: Set(cat_lines([
      tool_test_workspace_cmd,
      "",
    ])),
  }

run_bosatsu_node_tests_step =
  Step {
    run: Set(cat_lines([
      tool_test_workspace_node_cmd,
      "",
    ])),
    ..run_bosatsu_tests_step,
  }

workflow =
  Workflow(
    WorkflowJobs(
      WorkflowJobsTest(
        runner_ubuntu_latest,
        [
          *java_matrix_bootstrap_steps,
          Step {
            name: Set("run JVM tests"),
            run: Set(cat_lines([
              "sbt \"coreJVM/testOnly * -- --log=failure; cli/testOnly * -- --log=failure; doc; paradox\"",
              "./test_cli.sh",
              "",
            ])),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
      WorkflowJobsTestPY(
        needs_test,
        runner_ubuntu_latest,
        [
          *py_bootstrap_steps,
          Step {
            uses: Set(action_setup_python),
            name: Set("python setup"),
            with: Set(FetchJavaWith {
              `python-version`: Set(python_version_matrix),
            }),
          },
          Step { name: Set("build assembly"), run: Set("sbt \"cli/assembly\"") },
          Step { name: Set("generate python code"), run: Set(transpile_python_cmd) },
          Step { name: Set("run python tests"), run: Set(run_python_tests_cmd) },
        ],
        WorkflowJobsTestPYStrategy(
          WorkflowJobsTestPYStrategyMatrix(
            [ java_version_17 ],
            [ python_version_3_9 ],
          ),
        ),
        timeout_minutes_default,
      ),
      WorkflowJobsTestJS(
        needs_test,
        runner_ubuntu_latest,
        [
          *java_matrix_bootstrap_steps,
          Step {
            name: Set("run coreJS tests"),
            run: Set(cat_lines([
              "sbt \"coreJS/testOnly * -- --log=failure; jsapiJS/compile\"",
              "sbt \"jsuiJS/testOnly * -- --log=failure\"",
              "",
            ])),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
      WorkflowJobsTestWithCoverageReport(
        needs_test,
        runner_ubuntu_latest,
        [
          *coverage_bootstrap_steps,
          Step {
            name: Set("run tests with coverage"),
            run: Set(cat_lines([
              "sbt \"coverage; clean; coreJVM/testOnly * -- --log=failure; cli/testOnly * -- --log=failure; coverageReport\"",
              "",
            ])),
          },
          Step {
            uses: Set(action_codecov),
            name: Set("Upload to Codecov"),
            with: Set(FetchJavaWith { token: Set(codecov_token_secret) }),
          },
        ],
        java_strategy_17,
        timeout_minutes_default,
      ),
      WorkflowJobsNeedsRunStepsStrategy(
        needs_test,
        runner_ubuntu_latest,
        [
          *java_matrix_bootstrap_steps,
          Step {
            name: Set("build native image"),
            run: Set(cat_lines([
              "sbt \"cli/nativeImage\"",
              "cp cli/target/native-image/bosatsu-cli bosatsu",
              "",
            ])),
          },
          run_bosatsu_tests_step,
        ],
        java_strategy_17,
      ),
      WorkflowJobsNeedsRunStepsStrategy(
        needs_test,
        runner_ubuntu_latest,
        [
          *java_matrix_bootstrap_steps,
          Step {
            name: Set("build node"),
            run: Set(cat_lines([
              "sbt \"cliJSJS/fullOptJS\"",
              "",
            ])),
          },
          run_bosatsu_node_tests_step,
          Step {
            name: Set("install boehm"),
            run: Set("sudo apt-get update && sudo apt-get install -y libgc1 libgc-dev"),
          },
          Step {
            name: Set("install c runtime"),
            run: Set(cat_lines([
              "make -C c_runtime install VERSION=$(git rev-parse HEAD)",
              "",
            ])),
          },
          Step {
            name: Set("run lib test"),
            run: Set(cat_lines([
              "./bosatsu_node lib fetch",
              "lib_eval_out=$(${node_lib_eval_run_create_mode_cmd})",
              "echo \"$lib_eval_out\"",
              "echo \"$lib_eval_out\" | grep -q \"create_mode_test:ok\"",
              "tool_eval_out=$(${node_tool_eval_run_create_mode_cmd})",
              "echo \"$tool_eval_out\"",
              "echo \"$tool_eval_out\" | grep -q \"create_mode_test:ok\"",
              "mkdir node_out_lib",
              "./bosatsu_node lib test --outdir node_out_lib",
              "echo \"now test without a given outdir\"",
              "./bosatsu_node lib test",
              "",
            ])),
          },
        ],
        java_strategy_17,
      ),
      WorkflowJobsNeedsRunStrategyStepsTimeout(
        needs_test,
        runner_ubuntu_latest,
        java_strategy_17,
        [
          *c_build_bootstrap_steps,
          Step { name: Set("build assembly"), run: Set("sbt \"cli/assembly\"") },
          Step {
            name: Set("install boehm"),
            run: Set("sudo apt-get update && sudo apt install -y libgc1 libgc-dev pkg-config"),
          },
          Step { name: Set("test runtime code"), run: Set(run_c_runtime_ci) },
          Step { name: Set("generate and compile c code"), run: Set(transpile_c_cmd) },
          Step { name: Set("run generated c code"), run: Set("./c_out/test_exe") },
          Step {
            name: Set("check single assertion test output"),
            run: Set(cat_lines([
              "rm -rf issue1642_repro",
              "mkdir issue1642_repro",
              "cat > issue1642_repro/Foo.bosatsu <<'EOF'",
              "package Foo",
              "test = Assertion(True, \"foo\")",
              "EOF",
              "./bosatsuj tool transpile --input issue1642_repro/Foo.bosatsu --package_root issue1642_repro c --outdir issue1642_repro/out --test --exe_out test_exe --cc_flag=-O0 --cc_lib=-lm",
              "issue1642_repro/out/test_exe | tee issue1642_repro/output.txt",
              "grep -Eq '^Foo:$' issue1642_repro/output.txt",
              "grep -Eq '^    passed: .*1' issue1642_repro/output.txt",
              "",
            ])),
          },
          Step { name: Set("run lib test"), run: Set(run_lib_test_c) },
          Step { name: Set("run lib build"), run: Set(run_lib_build_c) },
        ],
        timeout_minutes_default,
      ),
      WorkflowJobsNeedsRunStrategyStepsTimeout(
        needs_test,
        runner_macos_latest,
        java_strategy_17,
        [
          *c_build_bootstrap_steps,
          Step { name: Set("build assembly"), run: Set("sbt \"cli/assembly\"") },
          Step { name: Set("install boehm"), run: Set("brew install bdw-gc pkg-config") },
          Step { name: Set("test runtime code"), run: Set(run_c_runtime_ci) },
          Step { name: Set("generate and compile c code"), run: Set(transpile_c_cmd) },
          Step { name: Set("run generated c code"), run: Set("./c_out/test_exe") },
          Step { name: Set("run lib test"), run: Set(run_lib_test_c) },
          Step { name: Set("run lib build"), run: Set(run_lib_build_c) },
        ],
        timeout_minutes_default,
      ),
      WorkflowJobsLibPublishDryRun(
        needs_test_c,
        runner_ubuntu_latest,
        [
          *java_matrix_bootstrap_steps,
          Step { name: Set("build assembly"), run: Set("sbt \"cli/assembly\"") },
          Step {
            name: Set("dry run bosatsu lib publish"),
            run: Set(run_publish_bosatsu_libs),
            env: Set(StepEnv {
              `REPO_ROOT`: Set("\${{ github.workspace }}"),
              `OUTDIR`: Set("\${{ runner.temp }}/bosatsu_lib_publish"),
              `GIT_SHA`: Set("\${{ github.sha }}"),
              `URI_BASE`: Set("https://example.invalid/"),
            }),
          },
        ],
        java_strategy_17,
      ),
    ),
    "ci",
    WorkflowOn(WorkflowOnPullRequest),
  )
