package Bosatsu/Prog

export (unit, pure, raise_error, recover, await, recursive, map, map_err, Prog, Main())

external struct Prog[err: +*, res: +*]

external def pure[err, res](a: res) -> Prog[err, res]
external def raise_error[err, res](e: err) -> Prog[err, res]
external def flat_map(prog: Prog[err, res], fn: res -> Prog[err, res1]) -> Prog[err, res1]

def map(prog: Prog[err, res], fn: res -> res1) -> Prog[err, res1]:
  prog.flat_map(res -> pure(fn(res)))

external def recover(prog: Prog[err, res], fn: err -> Prog[err1, res]) -> Prog[err1, res]

def map_err(prog: Prog[err, res], fn: err -> err1) -> Prog[err1, res]:
  prog.recover(res -> raise_error(fn(res)))

external def apply_fix(a: a,
  fn: (a -> Prog[err, b]) -> (a -> Prog[err, b])) -> Prog[err, b]

def await(p, fn): p.flat_map(fn)

def recursive(fn: (a -> Prog[err, b]) -> (a -> Prog[err, b])) -> (a -> Prog[err, b]):
  a -> apply_fix(a, fn)

unit: forall err. Prog[err, ()] = pure(())

struct Main(run: List[String] -> forall err. Prog[err, Int])
