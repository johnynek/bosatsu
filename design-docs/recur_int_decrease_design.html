<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>recur Type-Directed Decrease Design · Bosatsu Documentation</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='paradox docs'/>
<link rel="canonical" href="https://github.com/johnynek/bosatsudesign-docs/recur_int_decrease_design.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Bosatsu Documentation
</a>
<div class="version-number">
0.0.0+1-1d59386c*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../design.html" class="page">Bosatsu Design Philosophy and Goals</a></li>
  <li><a href="../design-docs/index.html" class="page">Design Docs</a></li>
  <li><a href="../getting_started.html" class="page">Getting started (new repo)</a></li>
  <li><a href="../language_guide.html" class="page">Language Guide</a></li>
  <li><a href="../recursion.html" class="page">Recursion in Bosatsu</a></li>
  <li><a href="../generating_json.html" class="page">Generating JSON from Bosatsu Values</a></li>
  <li><a href="../debugging_with_eval.html" class="page">Debugging with <code>lib eval</code></a></li>
  <li><a href="../debugging_with_show.html" class="page">Inspecting Compiled Output with <code>lib show</code></a></li>
  <li><a href="../transpile_python.html" class="page">Compiling to Python</a></li>
  <li><a href="../generated/core_alpha/index.html" class="page">Core Alpha API</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Bosatsu Documentation</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Bosatsu Documentation
</a>
<div class="version-number">
0.0.0+1-1d59386c*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../design.html" class="page">Bosatsu Design Philosophy and Goals</a></li>
  <li><a href="../design-docs/index.html" class="page">Design Docs</a></li>
  <li><a href="../getting_started.html" class="page">Getting started (new repo)</a></li>
  <li><a href="../language_guide.html" class="page">Language Guide</a></li>
  <li><a href="../recursion.html" class="page">Recursion in Bosatsu</a></li>
  <li><a href="../generating_json.html" class="page">Generating JSON from Bosatsu Values</a></li>
  <li><a href="../debugging_with_eval.html" class="page">Debugging with <code>lib eval</code></a></li>
  <li><a href="../debugging_with_show.html" class="page">Inspecting Compiled Output with <code>lib show</code></a></li>
  <li><a href="../transpile_python.html" class="page">Compiling to Python</a></li>
  <li><a href="../generated/core_alpha/index.html" class="page">Core Alpha API</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Bosatsu Documentation</a></li>
  <li><a href="../design-docs/index.html">Design Docs</a></li>
  <li><code>recur</code> Type-Directed Decrease Design</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#recur-type-directed-decrease-design" name="recur-type-directed-decrease-design" class="anchor"><span class="anchor-link"></span></a><code>recur</code> Type-Directed Decrease Design</h1>
<p>Status: proposed<br/>Date: 2026-02-28</p>
<h2><a href="#goal" name="goal" class="anchor"><span class="anchor-link"></span></a>Goal</h2>
<p>Enable total recursion over <code>Int</code> without adding new <code>recur</code> syntax. Recursion strategy should be selected from the target type, not from a user-written <code>by ...</code> clause.</p>
<h2><a href="#non-goals" name="non-goals" class="anchor"><span class="anchor-link"></span></a>Non-goals</h2>
<ol>
  <li>Full automatic termination proving.</li>
  <li>User-authored proof terms.</li>
  <li>Implementing enum-based decrease rules in phase 1.</li>
  <li>Changing runtime semantics of <code>recur</code>.</li>
</ol>
<h2><a href="#why-this-change" name="why-this-change" class="anchor"><span class="anchor-link"></span></a>Why this change</h2>
<p>The previous draft required syntax like <code>recur i by int_decrease:</code>. That is now the wrong abstraction boundary. The recursion checker should choose the strategy from type information: 1. Types can expose zero or more decrease strategies. 2. <code>recur</code> syntax remains unchanged. 3. Strategy application is an internal checker choice, not source-level syntax.</p>
<h2><a href="#language-surface" name="language-surface" class="anchor"><span class="anchor-link"></span></a>Language Surface</h2>
<p>No syntax change.</p>
<p>Valid source remains:</p>
<pre class="prettyprint"><code class="language-bosatsu">def int_loop[a](i: Int, state: a, fn: (Int, a) -&gt; (Int, a)) -&gt; a:
  recur i:
    ...
</code></pre>
<p>There is no <code>by int_decrease</code> form in this design.</p>
<h2><a href="#type-directed-strategy-model" name="type-directed-strategy-model" class="anchor"><span class="anchor-link"></span></a>Type-Directed Strategy Model</h2>
<p>At each recursive self-call, for each recur target, the checker: 1. Looks up the target type. 2. Finds applicable recursion strategies for that type. 3. Tries to discharge the obligations for at least one applicable strategy. 4. Reports an error if no strategy can be proven.</p>
<p>This keeps <code>recur</code> syntax stable while allowing strategy growth by type over time.</p>
<h2><a href="#phase-1-int-strategy" name="phase-1-int-strategy" class="anchor"><span class="anchor-link"></span></a>Phase 1: <code>Int</code> Strategy</h2>
<p><code>Int</code> gets one strategy in phase 1: 1. measure is the next recursive <code>Int</code> argument, 2. recursive call must decrease strictly, 3. recursive argument must stay in the non-negative region.</p>
<p>For current value <code>i</code>, next recursive value <code>next_i</code>, and path condition <code>PC</code>, require: 1. <code>PC =&gt; next_i &gt;= 0</code> 2. <code>PC =&gt; next_i &lt; i</code></p>
<p>This is the same well-founded argument as before, but now selected because the target type is <code>Int</code>, not because syntax requested <code>int_decrease</code>.</p>
<h2><a href="#example" name="example" class="anchor"><span class="anchor-link"></span></a>Example</h2>
<pre class="prettyprint"><code class="language-bosatsu">def int_loop[a](i: Int, state: a, fn: (Int, a) -&gt; (Int, a)) -&gt; a:
  recur i:
    case _ if i &gt; 0:
      (next_i, next_state) = fn(i, state)
      if next_i &gt; 0:
        if next_i &lt; i:
          int_loop(next_i, next_state, fn)
        else:
          next_state
      else:
        next_state
    case _:
      state
</code></pre>
<p>On the recursive call path, guards provide facts to prove both <code>Int</code> obligations.</p>
<h2><a href="#using-existing-dev-bosatsu-smt-support" name="using-existing-dev-bosatsu-smt-support" class="anchor"><span class="anchor-link"></span></a>Using Existing <code>dev.bosatsu.smt</code> Support</h2>
<p>The repository already has useful SMT infrastructure in <code>core/src/main/scala/dev/bosatsu/smt</code>: 1. <code>SmtExpr</code> models integer/bool terms and comparisons (<code>Lt</code>, <code>Gte</code>, <code>And</code>, <code>Not</code>, etc.). 2. <code>SmtCommand</code>/<code>SmtScript</code> build scripts (<code>SetLogic</code>, <code>DeclareConst</code>, <code>Assert</code>, <code>CheckSat</code>, <code>GetModel</code>). 3. <code>SmtLibRender</code> renders SMT-LIB text. 4. <code>Z3Api</code> parses solver status/model output and returns structured results.</p>
<p>For an obligation <code>PC =&gt; goal</code>, the checker can emit: 1. declarations for free variables, 2. <code>(assert PC)</code>, 3. <code>(assert (not goal))</code>, 4. <code>(check-sat)</code> (and optional <code>(get-model)</code>).</p>
<p>Interpretation: 1. <code>unsat</code>: obligation proven, 2. <code>sat</code>: obligation failed (use model in diagnostics), 3. <code>unknown</code>/execution failure: fail conservatively.</p>
<h2><a href="#compiler-placement" name="compiler-placement" class="anchor"><span class="anchor-link"></span></a>Compiler Placement</h2>
<ol>
  <li>Keep existing declaration-phase recursion checks for structural shape.</li>
  <li>Run typed recursion termination checks after inference, when argument types and call targets are resolved.</li>
  <li>In typed checking, dispatch strategy by recur-target type (<code>Int</code> in phase 1).</li>
</ol>
<p>No parser changes are required for this issue.</p>
<h2><a href="#error-reporting" name="error-reporting" class="anchor"><span class="anchor-link"></span></a>Error Reporting</h2>
<p>When an <code>Int</code> obligation fails, report: 1. recursive call location, 2. failed obligation (<code>next_i &gt;= 0</code> or <code>next_i &lt; i</code>), 3. simplified path condition used, 4. model values when solver returns <code>sat</code>.</p>
<h2><a href="#future-direction-enums-not-phase-1-" name="future-direction-enums-not-phase-1-" class="anchor"><span class="anchor-link"></span></a>Future Direction: Enums (Not Phase 1)</h2>
<p>We should keep moving toward one unified, type-directed notion of decrease.</p>
<p>A likely next step for enums: 1. <code>EnumOrdinal</code>: constructor declaration order defines base order. 2. Example: <code>enum Opt[a]: None, Some(v: a)</code> gives <code>None &lt; Some(_)</code>.</p>
<p>Possible refinement after that: 1. For same constructor, compare payloads when payload types have applicable strategies. 2. Example direction: <code>Some(n) &lt; Some(m)</code> when <code>n &lt; m</code>.</p>
<p>These enum refinements are intentionally out of scope for phase 1, but this type-dispatch design leaves room for them without introducing new syntax.</p>
<h2><a href="#test-plan" name="test-plan" class="anchor"><span class="anchor-link"></span></a>Test Plan</h2>
<ol>
  <li>Parser regression: existing <code>recur</code> parsing unchanged; no <code>by int_decrease</code> syntax.</li>
  <li>Positive typed recursion tests: accepted <code>Int</code> loops with provable decrease.</li>
  <li>Negative typed recursion tests: reject non-decreasing or non-provable <code>Int</code> calls.</li>
  <li>Structural recursion regression: existing ADT recursion behavior unchanged.</li>
  <li>Solver failure policy: <code>unknown</code>/execution failure remains conservative error.</li>
</ol>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/johnynek/bosatsu/tree/master/docs/src/main/paradox/design-docs/recur_int_decrease_design.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../getting_started.html">Getting started (new repo)</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../design-docs/recur_int_decrease_design.html#recur-type-directed-decrease-design" class="header"><code>recur</code> Type-Directed Decrease Design</a></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2026</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.0.0+1-1d59386c-SNAPSHOT', 'https://github.com/johnynek/bosatsu')});</script>


</html>
