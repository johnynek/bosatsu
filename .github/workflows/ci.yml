jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "run JVM tests"
        run: |
          sbt "coreJVM/test; cli/test; doc; paradox"
          ./test_cli.sh
    strategy:
      matrix:
        java:
          - '17'
    timeout-minutes: 30
  testPY:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "python setup"
        uses: "actions/setup-python@v2"
        with:
          python-version: "${{matrix.python}}"
      - name: "build assembly"
        run: 'sbt "cli/assembly"'
      - name: "generate python code"
        run: "./bosatsuj tool transpile --input_dir test_workspace/ --input test_workspace/Bosatsu/IO/Error.bosatsu --input test_workspace/Bosatsu/Collection/Array.bosatsu --input test_workspace/Bosatsu/IO/Core.bosatsu --input test_workspace/Bosatsu/IO/Bytes.bosatsu --input test_workspace/Bosatsu/IO/Std.bosatsu --package_root test_workspace/ python --outdir pyout --externals test_workspace/Prog.bosatsu_externals --evaluators test_workspace/Prog.bosatsu_eval"
      - name: "run python tests"
        run: "PYTHONPATH=$PYTHONPATH:$(pwd)/test_workspace:$(pwd)/pyout python3 -m unittest discover pyout -v --pattern \"*.py\""
    strategy:
      matrix:
        java:
          - '17'
        python:
          - '3.9'
    timeout-minutes: 30
  testJS:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "run coreJS tests"
        run: |
          sbt "coreJS/test; jsapiJS/compile"
          sbt "jsuiJS/test"
    strategy:
      matrix:
        java:
          - '17'
    timeout-minutes: 30
  testWithCoverageReport:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
        with:
          fetch-depth: 0
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "run tests with coverage"
        run: |
          sbt "coverage; clean; coreJVM/test; cli/test; coverageReport"
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
    strategy:
      matrix:
        java:
          - '17'
    timeout-minutes: 30
  buildWithGraal:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "build native image"
        run: |
          sbt "cli/nativeImage"
          cp cli/target/native-image/bosatsu-cli bosatsu
      - name: "run bosatsu tests"
        run: |
          ./bosatsu tool test --input_dir test_workspace/ --input test_workspace/Bosatsu/IO/Error.bosatsu --input test_workspace/Bosatsu/Collection/Array.bosatsu --input test_workspace/Bosatsu/IO/Core.bosatsu --input test_workspace/Bosatsu/IO/Bytes.bosatsu --input test_workspace/Bosatsu/IO/Std.bosatsu --package_root test_workspace/
    strategy:
      matrix:
        java:
          - '17'
  testWithNode:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "build node"
        run: |
          sbt "cliJSJS/fullOptJS"
      - name: "run bosatsu tests"
        run: |
          ./bosatsu_node tool test --input_dir test_workspace/ --input test_workspace/Bosatsu/IO/Error.bosatsu --input test_workspace/Bosatsu/Collection/Array.bosatsu --input test_workspace/Bosatsu/IO/Core.bosatsu --input test_workspace/Bosatsu/IO/Bytes.bosatsu --input test_workspace/Bosatsu/IO/Std.bosatsu --package_root test_workspace/
      - name: "install boehm"
        run: "sudo apt-get update && sudo apt-get install -y libgc1 libgc-dev"
      - name: "install c runtime"
        run: |
          make -C c_runtime install VERSION=$(git rev-parse HEAD)
      - name: "run lib test"
        run: |
          ./bosatsu_node lib fetch
          mkdir node_out_lib
          ./bosatsu_node lib test --outdir node_out_lib
          echo "now test without a given outdir"
          ./bosatsu_node lib test
    strategy:
      matrix:
        java:
          - '17'
  testC:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java:
          - '17'
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "build assembly"
        run: 'sbt "cli/assembly"'
      - name: "install boehm"
        run: "sudo apt-get update && sudo apt install -y libgc1 libgc-dev pkg-config"
      - name: "test runtime code"
        run: |
          cd c_runtime
          rm -f test_exe
          make PROFILE=debug && git diff --quiet || { git diff; false; }
          make boehm_example PROFILE=release
          make install PROFILE=release CFLAGS="-O1 -g" CPPFLAGS="-DBSTS_CI=1"
          ./test_exe && ./boehm_example
          make bench_exe PROFILE=release
          ./bench_exe 1000000 | tee bench_ci.txt
          cd ..
          export SHA=$(./bosatsuj version -g)
          python3 - <<'PY'
          import json
          import os
          import pathlib

          sha = os.environ["SHA"]
          conf_path = pathlib.Path(".bosatsuc") / sha / "cc_conf.json"
          conf = json.loads(conf_path.read_text())
          assert "-O1" in conf["flags"], conf
          assert "-DBSTS_CI=1" in conf["flags"] or "-DBSTS_CI=1" in conf["iflags"], conf
          print(f"validated {conf_path}")
          PY
      - name: "generate and compile c code"
        run: "./bosatsuj tool transpile --input_dir test_workspace/ --input test_workspace/Bosatsu/IO/Error.bosatsu --input test_workspace/Bosatsu/Collection/Array.bosatsu --input test_workspace/Bosatsu/IO/Core.bosatsu --input test_workspace/Bosatsu/IO/Bytes.bosatsu --input test_workspace/Bosatsu/IO/Std.bosatsu --package_root test_workspace/ c --outdir c_out --test --exe_out test_exe --cc_flag=-O0 --cc_lib=-lm"
      - name: "run generated c code"
        run: ./c_out/test_exe
      - name: "check single assertion test output"
        run: |
          rm -rf issue1642_repro
          mkdir issue1642_repro
          cat > issue1642_repro/Foo.bosatsu <<'EOF'
          package Foo
          test = Assertion(True, "foo")
          EOF
          ./bosatsuj tool transpile --input issue1642_repro/Foo.bosatsu --package_root issue1642_repro c --outdir issue1642_repro/out --test --exe_out test_exe --cc_flag=-O0 --cc_lib=-lm
          issue1642_repro/out/test_exe | tee issue1642_repro/output.txt
          grep -Eq '^Foo:$' issue1642_repro/output.txt
          grep -Eq '^    passed: .*1' issue1642_repro/output.txt
      - name: "run lib test"
        run: |
          ./bosatsuj lib fetch
          mkdir c_out_lib
          ./bosatsuj lib test --outdir c_out_lib --cc_flag=-O0 --cc_lib=-lm
          echo "now test without a given outdir"
          ./bosatsuj lib test --cc_flag=-O0 --cc_lib=-lm
      - name: "run lib build"
        run: |
          mkdir c_out_build
          ./bosatsuj lib build --outdir c_out_build --main_pack Bosatsu/FibBench --exe_out fib_bench --cc_flag=-O0 --cc_lib=-lm
          ./c_out_build/fib_bench 10
    timeout-minutes: 30
  testCMacOS:
    needs: test
    runs-on: macos-latest
    strategy:
      matrix:
        java:
          - '17'
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "build assembly"
        run: 'sbt "cli/assembly"'
      - name: "install boehm"
        run: "brew install bdw-gc pkg-config"
      - name: "test runtime code"
        run: |
          cd c_runtime
          rm -f test_exe
          make PROFILE=debug && git diff --quiet || { git diff; false; }
          make boehm_example PROFILE=release
          make install PROFILE=release CFLAGS="-O1 -g" CPPFLAGS="-DBSTS_CI=1"
          ./test_exe && ./boehm_example
          make bench_exe PROFILE=release
          ./bench_exe 1000000 | tee bench_ci.txt
          cd ..
          export SHA=$(./bosatsuj version -g)
          python3 - <<'PY'
          import json
          import os
          import pathlib

          sha = os.environ["SHA"]
          conf_path = pathlib.Path(".bosatsuc") / sha / "cc_conf.json"
          conf = json.loads(conf_path.read_text())
          assert "-O1" in conf["flags"], conf
          assert "-DBSTS_CI=1" in conf["flags"] or "-DBSTS_CI=1" in conf["iflags"], conf
          print(f"validated {conf_path}")
          PY
      - name: "generate and compile c code"
        run: "./bosatsuj tool transpile --input_dir test_workspace/ --input test_workspace/Bosatsu/IO/Error.bosatsu --input test_workspace/Bosatsu/Collection/Array.bosatsu --input test_workspace/Bosatsu/IO/Core.bosatsu --input test_workspace/Bosatsu/IO/Bytes.bosatsu --input test_workspace/Bosatsu/IO/Std.bosatsu --package_root test_workspace/ c --outdir c_out --test --exe_out test_exe --cc_flag=-O0 --cc_lib=-lm"
      - name: "run generated c code"
        run: ./c_out/test_exe
      - name: "run lib test"
        run: |
          ./bosatsuj lib fetch
          mkdir c_out_lib
          ./bosatsuj lib test --outdir c_out_lib --cc_flag=-O0 --cc_lib=-lm
          echo "now test without a given outdir"
          ./bosatsuj lib test --cc_flag=-O0 --cc_lib=-lm
      - name: "run lib build"
        run: |
          mkdir c_out_build
          ./bosatsuj lib build --outdir c_out_build --main_pack Bosatsu/FibBench --exe_out fib_bench --cc_flag=-O0 --cc_lib=-lm
          ./c_out_build/fib_bench 10
    timeout-minutes: 30
  libPublishDryRun:
    needs: testC
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v2.1.0"
      - name: "Cache sbt directories"
        uses: "actions/cache@v4"
        with:
          path: |
            .sbt-local
            ~/.ivy2/cache
            ~/.sbt
            ~/.cache/coursier
          key: "sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/**/*.scala', 'project/build.properties', 'project/plugins.sbt', '.sbtopts') }}"
          restore-keys: |
            sbt-${{ runner.os }}-
      - name: "java ${{matrix.java}} setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "${{matrix.java}}"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "build assembly"
        run: 'sbt "++3.8.1; cli/assembly"'
      - name: "dry run bosatsu lib publish"
        env:
          REPO_ROOT: ${{ github.workspace }}
          OUTDIR: ${{ runner.temp }}/bosatsu_lib_publish
          GIT_SHA: ${{ github.sha }}
          URI_BASE: https://example.invalid/
        run: |
          chmod +x scripts/publish_bosatsu_libs.sh
          scripts/publish_bosatsu_libs.sh
    strategy:
      matrix:
        java:
          - '17'
name: ci
on:
  pull_request: {}
