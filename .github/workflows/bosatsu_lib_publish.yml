name: Publish Bosatsu libs

on:
  push:
    tags:
      - 'release-*'
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed to push commits and create releases

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # we want full history and tags
      - uses: "coursier/cache-action@v2"
      - name: "java 17 setup"
        uses: "olafurpg/setup-scala@v10"
        with:
          java-version: "17"
      - name: "build assembly"
        run: |
          sbt "++3.8.1; cli/assembly"
          cp cli/target/scala-3.8.1/bosatsu-cli-assembly-*.jar bosatsu.jar

      - name: Publish Bosatsu libraries
        env:
          REPO_ROOT: ${{ github.workspace }}
          OUTDIR: ${{ github.workspace }}/.bosatsu_lib_publish
          # git_sha should be the commit the tag points at
          GIT_SHA: ${{ github.sha }}
          URI_BASE: https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/
        run: |
          chmod +x scripts/publish_bosatsu_libs.sh
          scripts/publish_bosatsu_libs.sh

      - name: Commit core_conf.json changes back to main
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          # Show what changed so debugging is less painful
          echo "Changes after bosatsuj lib publish:"
          git status
          git diff

          # Configure author for the commit
          git config user.name "bosatsu-release-bot"
          git config user.email "bosatsu-release-bot@users.noreply.github.com"

          # Stage only the config files we expect to be mutated
          # Adjust this glob to your actual layout, e.g.:
          #   libs/core/core_conf.json
          #   libs/whatever/*/core_conf.json
          git add **/*_conf.json

          # If nothing changed, donâ€™t create an empty commit
          if git diff --cached --quiet; then
            echo "No core_conf.json changes to commit, skipping push."
            exit 0
          fi

          # Create a commit describing the release tag that triggered this
          git commit -m "Update lib conf.jsons for ${GITHUB_REF_NAME}"

          # Push this commit to main.
          # Assumption: the tag was created on the current tip of main.
          # This is effectively "merge into main" by fast-forward.
          git push origin HEAD:main

      - name: Create release and upload .bosatsu_lib assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: Bosatsu libs for ${{ github.ref_name }}
          body: |
            Bosatsu libraries built from commit ${{ github.sha }}.
            git_sha embedded in the libs: ${{ github.sha }}.
          files: |
            .bosatsu_lib_publish/*.bosatsu_lib
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
