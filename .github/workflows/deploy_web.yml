name: Build and Deploy to GitHub Pages

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      BOSATSU_CI: "true"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: coursier/cache-action@v6

      - name: Setup Scala and sbt
        uses: olafurpg/setup-scala@v14
        with:
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.50'

      - name: Install Playwright
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Build jsui
        run: |
          export NODE_OPTIONS=--openssl-legacy-provider
          sbt "jsuiJS/fullOptJS::webpack"

      - name: Build documentation
        run: sbt "docs/paradox"

      - name: Create deployment directory structure
        run: |
          mkdir -p web_deploy/compiler
          mkdir -p web_deploy/demo/examples
          mkdir -p web_deploy/demos/ui
          mkdir -p web_deploy/demos/simulation
          mkdir -p web_deploy/demos/benchmarks/ui-performance

      # ===== Simple Multi-Target Demo (fibonacci) =====
      - name: Build demo artifacts - JavaScript
        run: |
          sbt "cli/run transpile --input test_workspace/Prog.bosatsu --input demo/examples/fibonacci.bosatsu js --outdir web_deploy/demo/examples"

      - name: Build demo artifacts - C
        run: |
          sbt "cli/run transpile --input test_workspace/Prog.bosatsu --input demo/examples/fibonacci.bosatsu c --main Demo/Fibonacci --output fibonacci.c --outdir web_deploy/demo/examples"

      - name: Build WASM from C
        run: |
          emcc web_deploy/demo/examples/fibonacci.c \
            -I c_runtime \
            c_runtime/bosatsu_runtime.c \
            c_runtime/bosatsu_ext_Bosatsu_l_Predef.c \
            c_runtime/bosatsu_ext_Bosatsu_l_Prog.c \
            -sWASM=1 \
            -sEXPORTED_RUNTIME_METHODS='["ccall","cwrap"]' \
            -sEXPORTED_FUNCTIONS='["_main"]' \
            -sMODULARIZE=1 \
            -sEXPORT_NAME='Module' \
            -o web_deploy/demo/examples/fibonacci_wasm.js

      # ===== JS/WASM Interop Demo (Bosatsu JS orchestrator + WASM compute) =====
      - name: Build interop demo - Compile both files to JS bundle
        run: |
          sbt "cli/run transpile --input test_workspace/Prog.bosatsu --input demo/examples/compute.bosatsu --input demo/examples/orchestrator.bosatsu js --outdir web_deploy/demo/examples"

      - name: Build interop demo - Compile compute.bosatsu to C
        run: |
          sbt "cli/run transpile --input test_workspace/Prog.bosatsu --input demo/examples/compute.bosatsu c --main Demo/Compute --output compute.c --outdir web_deploy/demo/examples"

      - name: Build interop demo - Compile C to WASM
        run: |
          emcc web_deploy/demo/examples/compute.c \
            demo/wasm_wrapper.c \
            -I c_runtime \
            c_runtime/bosatsu_runtime.c \
            c_runtime/bosatsu_ext_Bosatsu_l_Predef.c \
            c_runtime/bosatsu_ext_Bosatsu_l_Prog.c \
            -sWASM=1 \
            -sEXPORTED_RUNTIME_METHODS='["ccall","cwrap"]' \
            -sEXPORTED_FUNCTIONS='["_wasm_init","_wasm_fib","_wasm_factorial","_wasm_collatz"]' \
            -sMODULARIZE=1 \
            -sEXPORT_NAME='createModule' \
            -sALLOW_MEMORY_GROWTH=1 \
            -O2 \
            -o web_deploy/demo/examples/compute_wasm.js

      # ===== BosatsuUI Demos =====
      - name: Generate BosatsuUI demos
        run: |
          sbt "simulationCli/run ui demos/ui/counter.bosatsu -o web_deploy/demos/ui/counter.html"
          sbt "simulationCli/run ui demos/ui/todo-list.bosatsu -o web_deploy/demos/ui/todo-list.html"

      # ===== Simulation Demos (Provenance) =====
      # These demos use Bosatsu/Numeric for proper floating-point arithmetic
      - name: Generate simulation demos with simulation-cli
        run: |
          sbt "simulationCli/run sim demo/loan_calculator_numeric_func.bosatsu demo/loan_calculator_numeric_func.sim.bosatsu -o web_deploy/demos/simulation/loan-calculator.html --title Loan_Calculator"
          sbt "simulationCli/run sim demo/tax_numeric.bosatsu demo/tax_numeric.sim.bosatsu -o web_deploy/demos/simulation/tax-calculator.html --title Tax_Calculator"
          sbt "simulationCli/run sim demo/carbon_numeric.bosatsu demo/carbon_numeric.sim.bosatsu -o web_deploy/demos/simulation/carbon-footprint.html --title Carbon_Footprint_Calculator"

      - name: Assemble deployment
        run: |
          # Copy documentation (paradox output)
          cp -a docs/target/paradox/site/main/* web_deploy/

          # Landing page
          cp web/index.html web_deploy/

          # Compiler UI
          cp jsui/index.html web_deploy/compiler/
          cp jsui/app.css web_deploy/compiler/
          cp jsui/.js/target/scala-3.8.1/scalajs-bundler/main/bosatsu-jsui-opt-bundle.js web_deploy/compiler/bosatsu_ui.js

          # Demo page (simple multi-target)
          cp demo/index.html web_deploy/demo/
          cp demo/demo.css web_deploy/demo/
          cp demo/demo.js web_deploy/demo/
          cp demo/examples/fibonacci.bosatsu web_deploy/demo/examples/

          # JS/WASM interop demo
          cp demo/interop.html web_deploy/demo/
          cp demo/interop.js web_deploy/demo/
          cp demo/wasm_wrapper.c web_deploy/demo/
          cp demo/examples/compute.bosatsu web_deploy/demo/examples/
          cp demo/examples/orchestrator.bosatsu web_deploy/demo/examples/

          # BosatsuUI demos index and assets
          cp demos/index.html web_deploy/demos/
          cp demos/ui/counter.bosatsu web_deploy/demos/ui/
          cp demos/ui/todo-list.bosatsu web_deploy/demos/ui/

          # Copy benchmarks placeholder (if exists)
          cp -r demos/benchmarks/* web_deploy/demos/benchmarks/ 2>/dev/null || echo "No benchmarks to copy"

          # Copy Bosatsu source files for simulation demos
          cp demo/loan_calculator_numeric_func.bosatsu demo/loan_calculator_numeric_func.sim.bosatsu web_deploy/demos/simulation/
          cp demo/tax_numeric.bosatsu demo/tax_numeric.sim.bosatsu web_deploy/demos/simulation/
          cp demo/carbon_numeric.bosatsu demo/carbon_numeric.sim.bosatsu web_deploy/demos/simulation/

          # Copy BosatsuUI runtime
          cp core/src/main/resources/bosatsu-ui-runtime.js web_deploy/

      # ===== E2E Tests =====
      - name: Run E2E tests
        run: |
          npx playwright test tests/e2e/meta-coverage.spec.ts tests/e2e/benchmark-integrity.spec.ts --project=chromium
        env:
          BASE_URL: file://${{ github.workspace }}/web_deploy

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web_deploy
