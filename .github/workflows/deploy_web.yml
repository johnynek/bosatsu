name: Build and Deploy to GitHub Pages

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      BOSATSU_CI: "true"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: "actions/checkout@v2.1.0"
      - uses: "coursier/cache-action@v6"
      - name: "java 17 setup"
        uses: "actions/setup-java@v5"
        with:
          distribution: "temurin"
          java-version: "17"
      - name: "install sbt"
        uses: "sbt/setup-sbt@v1"
      - name: "build app"
        run: |
          export NODE_OPTIONS=--openssl-legacy-provider
          sbt "jsuiJS/fullOptJS::webpack; docs/paradox"
          mkdir web_deploy
          mkdir web_deploy/compiler
          cp -a docs/target/paradox/site/main/* web_deploy
          cp jsui/index.html web_deploy/compiler/
          cp jsui/app.css web_deploy/compiler/
          bundle_path="$(ls -1t jsui/.js/target/scala-*/scalajs-bundler/main/compiler-jsui-opt-bundle.js 2>/dev/null | head -n 1 || true)"
          if [ -z "$bundle_path" ]; then
            echo "Unable to locate compiler-jsui-opt-bundle.js under jsui/.js/target/scala-*/" >&2
            exit 1
          fi
          cp "$bundle_path" web_deploy/compiler/bosatsu_ui.js

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web_deploy
