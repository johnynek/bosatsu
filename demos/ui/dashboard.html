<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BosatsuUI Real-Time Dashboard Demo</title>
  <!-- Real React 18 for comparison -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- BosatsuUI Runtime -->
  <script src="../../core/src/main/resources/bosatsu-ui-runtime.js"></script>
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #1a1a2e;
  color: #eee;
  min-height: 100vh;
  padding: 20px;
}

.header {
  text-align: center;
  margin-bottom: 24px;
}

.header h1 {
  color: #667eea;
  margin-bottom: 8px;
}

.header .subtitle {
  color: #888;
  font-size: 14px;
}

.controls {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.controls button {
  padding: 12px 24px;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: transform 0.1s, box-shadow 0.1s;
}

.controls button:hover {
  transform: translateY(-2px);
}

.controls button.primary {
  background: #667eea;
  color: white;
}

.controls button.secondary {
  background: #444;
  color: white;
}

.controls button.danger {
  background: #dc3545;
  color: white;
}

.controls button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.stats-bar {
  display: flex;
  justify-content: center;
  gap: 32px;
  margin-bottom: 24px;
  padding: 16px;
  background: #222;
  border-radius: 12px;
}

.stat {
  text-align: center;
}

.stat-label {
  font-size: 12px;
  color: #888;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  font-family: monospace;
}

.stat-value.bosatsu { color: #667eea; }
.stat-value.react { color: #61dafb; }
.stat-value.advantage { color: #4caf50; }

.dashboards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

.dashboard {
  background: #222;
  border-radius: 12px;
  padding: 20px;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #333;
}

.dashboard-title {
  font-size: 18px;
  font-weight: 600;
}

.dashboard-title.bosatsu { color: #667eea; }
.dashboard-title.react { color: #61dafb; }

.update-rate {
  font-size: 12px;
  color: #888;
}

.value-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}

.value-cell {
  background: #333;
  border-radius: 6px;
  padding: 12px 8px;
  text-align: center;
  transition: background 0.1s;
}

.value-cell.updated {
  background: #3d3d5c;
}

.value-label {
  font-size: 10px;
  color: #888;
  margin-bottom: 4px;
}

.value-number {
  font-size: 18px;
  font-weight: bold;
  font-family: monospace;
}

.explainer {
  max-width: 1400px;
  margin: 24px auto 0;
  background: #2d2d44;
  padding: 20px;
  border-radius: 12px;
}

.explainer h3 {
  color: #667eea;
  margin-bottom: 12px;
}

.explainer p {
  color: #aaa;
  line-height: 1.6;
  margin-bottom: 12px;
}

.explainer code {
  background: #1a1a2e;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
  color: #f0c674;
}

@media (max-width: 900px) {
  .dashboards {
    grid-template-columns: 1fr;
  }
  .value-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}
  </style>
</head>
<body>
  <div class="header">
    <h1>Real-Time Dashboard Demo</h1>
    <p class="subtitle">BosatsuUI vs React 18 - Simulated WebSocket-style rapid updates</p>
  </div>

  <div class="controls">
    <button class="primary" id="start-btn" onclick="startUpdates()">Start Updates</button>
    <button class="secondary" id="stop-btn" onclick="stopUpdates()" disabled>Stop Updates</button>
    <button class="danger" id="reset-btn" onclick="resetStats()">Reset Stats</button>
  </div>

  <div class="stats-bar">
    <div class="stat">
      <div class="stat-label">BosatsuUI Batches/sec</div>
      <div class="stat-value bosatsu" id="bosatsu-rate">0</div>
    </div>
    <div class="stat">
      <div class="stat-label">React Batches/sec</div>
      <div class="stat-value react" id="react-rate">0</div>
    </div>
    <div class="stat">
      <div class="stat-label">Status</div>
      <div class="stat-value advantage" id="advantage">Ready</div>
    </div>
  </div>

  <div class="dashboards">
    <!-- BosatsuUI Dashboard -->
    <div class="dashboard">
      <div class="dashboard-header">
        <div class="dashboard-title bosatsu">BosatsuUI Dashboard</div>
        <div class="update-rate">Direct DOM binding</div>
      </div>
      <div class="value-grid" id="bosatsu-grid"></div>
    </div>

    <!-- React Dashboard -->
    <div class="dashboard">
      <div class="dashboard-header">
        <div class="dashboard-title react">React 18 Dashboard</div>
        <div class="update-rate">Virtual DOM diffing</div>
      </div>
      <div class="value-grid" id="react-grid"></div>
    </div>
  </div>

  <div class="explainer">
    <h3>How This Demo Works</h3>
    <p>
      Both dashboards receive identical simulated "WebSocket" updates at the same rate.
      BosatsuUI uses <code>batchSize: Infinity</code> with <code>flushDelay: 'microtask'</code>
      (equivalent to React 18's automatic batching) but skips VDOM diffing entirely.
    </p>
    <p>
      <strong>Why BosatsuUI is faster:</strong> When updating <code>['metrics', 'cpu']</code>,
      BosatsuUI does O(1) map lookup + direct DOM write. React must create new VDOM tree,
      diff against old tree, and reconcile 50+ children.
    </p>
    <p>
      <strong>Note:</strong> This demo simulates high-frequency updates. In real applications,
      you'd typically throttle updates for smooth visualization.
    </p>
  </div>

  <script>
    // ==========================================================================
    // Configuration
    // ==========================================================================
    const METRIC_COUNT = 50;
    const UPDATE_INTERVAL_MS = 10; // How often to trigger batch updates
    const UPDATES_PER_BATCH = 5;   // How many metrics to update per batch

    // ==========================================================================
    // Setup BosatsuUI Dashboard
    // ==========================================================================
    const bosatsuGrid = document.getElementById('bosatsu-grid');
    const bosatsuBindings = {};
    const bosatsuInitialState = { metrics: {} };

    // Create cells and bindings
    for (let i = 0; i < METRIC_COUNT; i++) {
      const cell = document.createElement('div');
      cell.className = 'value-cell';
      cell.innerHTML = `
        <div class="value-label">Metric ${i + 1}</div>
        <div class="value-number" id="bosatsu-metric-${i}">0</div>
      `;
      bosatsuGrid.appendChild(cell);

      // Create binding for this metric
      const path = `metrics.${i}`;
      bosatsuBindings[path] = [{
        elementId: `bosatsu-metric-${i}`,
        property: 'textContent',
        statePath: ['metrics', String(i)]
      }];
      bosatsuInitialState.metrics[i] = 0;
    }

    // Initialize BosatsuUI runtime with full batching
    BosatsuUI.configure({ batchSize: Infinity, flushDelay: 'microtask' });
    BosatsuUI._initRuntime(bosatsuBindings, bosatsuInitialState);

    // Build element cache
    for (let i = 0; i < METRIC_COUNT; i++) {
      const el = document.getElementById(`bosatsu-metric-${i}`);
      BosatsuUI._elementCache.set(`[data-bosatsu-id="bosatsu-metric-${i}"]`, el);
      BosatsuUI._elementCache.set(`#bosatsu-metric-${i}`, el);
    }

    // ==========================================================================
    // Setup React Dashboard
    // ==========================================================================
    const { useState, useEffect, memo } = React;

    // Memoized metric cell to minimize re-renders
    const MetricCell = memo(function MetricCell({ index, value }) {
      return React.createElement('div', { className: 'value-cell' },
        React.createElement('div', { className: 'value-label' }, `Metric ${index + 1}`),
        React.createElement('div', { className: 'value-number' }, value)
      );
    });

    function ReactDashboard() {
      const [metrics, setMetrics] = useState(() =>
        Object.fromEntries(Array.from({ length: METRIC_COUNT }, (_, i) => [i, 0]))
      );

      // Expose setter for benchmark
      window._reactSetMetrics = setMetrics;

      return React.createElement('div', { className: 'value-grid' },
        Object.entries(metrics).map(([i, value]) =>
          React.createElement(MetricCell, { key: i, index: parseInt(i), value })
        )
      );
    }

    // Mount React
    const reactGrid = document.getElementById('react-grid');
    const reactRoot = ReactDOM.createRoot(reactGrid);
    reactRoot.render(React.createElement(ReactDashboard));

    // ==========================================================================
    // Update Logic
    // ==========================================================================
    let updateInterval = null;
    let bosatsuUpdateCount = 0;
    let reactUpdateCount = 0;
    let lastStatUpdate = performance.now();

    function generateRandomValue() {
      return Math.floor(Math.random() * 1000);
    }

    function getRandomIndices(count) {
      const indices = [];
      for (let i = 0; i < count; i++) {
        indices.push(Math.floor(Math.random() * METRIC_COUNT));
      }
      return indices;
    }

    function performUpdates() {
      const indices = getRandomIndices(UPDATES_PER_BATCH);

      // Update BosatsuUI - count batches, not individual setState calls
      indices.forEach(i => {
        const value = generateRandomValue();
        BosatsuUI.setState(['metrics', String(i)], value);
      });
      bosatsuUpdateCount++;  // Count once per batch, not per setState

      // Update React (same values, same indices)
      window._reactSetMetrics(prev => {
        const next = { ...prev };
        indices.forEach(i => {
          next[i] = generateRandomValue();
        });
        return next;
      });
      reactUpdateCount++;  // Count once per batch

      // Update stats display periodically
      const now = performance.now();
      if (now - lastStatUpdate > 500) {
        const elapsed = (now - lastStatUpdate) / 1000;  // Actual elapsed time in seconds
        updateStatsDisplay(elapsed);
        lastStatUpdate = now;
      }
    }

    function updateStatsDisplay(elapsed) {
      const bosatsuRate = Math.round(bosatsuUpdateCount / elapsed);
      const reactRate = Math.round(reactUpdateCount / elapsed);

      document.getElementById('bosatsu-rate').textContent = bosatsuRate.toLocaleString();
      document.getElementById('react-rate').textContent = reactRate.toLocaleString();

      // Both frameworks process the same batches - show status
      if (bosatsuRate > 0 && reactRate > 0) {
        document.getElementById('advantage').textContent = 'Running';
      }

      // Reset counters
      bosatsuUpdateCount = 0;
      reactUpdateCount = 0;
    }

    function startUpdates() {
      if (updateInterval) return;

      document.getElementById('start-btn').disabled = true;
      document.getElementById('stop-btn').disabled = false;

      lastStatUpdate = performance.now();
      updateInterval = setInterval(performUpdates, UPDATE_INTERVAL_MS);
    }

    function stopUpdates() {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }

      document.getElementById('start-btn').disabled = false;
      document.getElementById('stop-btn').disabled = true;
    }

    function resetStats() {
      stopUpdates();
      bosatsuUpdateCount = 0;
      reactUpdateCount = 0;

      document.getElementById('bosatsu-rate').textContent = '0';
      document.getElementById('react-rate').textContent = '0';
      document.getElementById('advantage').textContent = 'Stopped';

      // Reset all values to 0
      for (let i = 0; i < METRIC_COUNT; i++) {
        BosatsuUI.setState(['metrics', String(i)], 0);
      }
      window._reactSetMetrics(
        Object.fromEntries(Array.from({ length: METRIC_COUNT }, (_, i) => [i, 0]))
      );
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', stopUpdates);
  </script>
</body>
</html>
